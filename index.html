<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebRTC Минимал — только микрофон</title>
    <style>
        body {
            margin: 0;
            background: #0b0f14;
            color: #e6eef7;
            font: 15px system-ui, sans-serif;
        }

        header {
            padding: 10px 14px;
            font-weight: bold;
            background: #121821;
        }

        main {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        textarea {
            width: 100%;
            min-height: 100px;
            font-size: 12px;
        }

        button {
            margin: 4px 0;
            padding: 6px 10px;
        }
    </style>
</head>

<body>
    <header>WebRTC минимал — только аудио</header>
    <main>
        <button id="btnStart">Включить микрофон</button>
        <div>
            <h3>Звонящий</h3>
            <button id="btnOffer">Создать Offer</button>
            <textarea id="offer" placeholder="Offer"></textarea>
            <button id="btnSetAnswer">Вставить Answer → Set Remote</button>
            <textarea id="answerIn" placeholder="Answer"></textarea>
        </div>
        <div>
            <h3>Отвечающий</h3>
            <button id="btnMakeAnswer">Вставить Offer → Answer</button>
            <textarea id="offerIn" placeholder="Offer"></textarea>
            <textarea id="answerOut" placeholder="Answer"></textarea>
        </div>
    </main>
    <script>
        const $ = id => document.getElementById(id);
        let pc, localStream;

        function createPeer() {
            if (pc) return pc;
            pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            pc.ontrack = e => { const audio = new Audio(); audio.srcObject = e.streams[0]; audio.autoplay = true; };
            return pc;
        }

        async function startLocal() {
            if (localStream) return;
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            createPeer();
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        }

        async function makeOffer() {
            await startLocal();
            createPeer();
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await new Promise(r => { if (pc.iceGatheringState === 'complete') return r(); pc.onicegatheringstatechange = () => { if (pc.iceGatheringState === 'complete') r(); }; });
            $("offer").value = JSON.stringify(pc.localDescription);
        }

        async function acceptOfferAndMakeAnswer() {
            await startLocal();
            createPeer();
            const offer = JSON.parse($("offerIn").value.trim());
            await pc.setRemoteDescription(offer);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            await new Promise(r => { if (pc.iceGatheringState === 'complete') return r(); pc.onicegatheringstatechange = () => { if (pc.iceGatheringState === 'complete') r(); }; });
            $("answerOut").value = JSON.stringify(pc.localDescription);
        }

        async function setRemoteAnswer() {
            const answer = JSON.parse($("answerIn").value.trim());
            await pc.setRemoteDescription(answer);
        }

        $("btnStart").onclick = startLocal;
        $("btnOffer").onclick = makeOffer;
        $("btnMakeAnswer").onclick = acceptOfferAndMakeAnswer;
        $("btnSetAnswer").onclick = setRemoteAnswer;
    </script>
</body>

</html>