<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebRTC Минимал — камера + микрофон</title>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <style>
        body {
            margin: 0;
            background: #0b0f14;
            color: #e6eef7;
            font: 15px system-ui, sans-serif;
        }

        header {
            padding: 10px 14px;
            font-weight: bold;
            background: #121821;
        }

        main {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        video {
            width: 100%;
            background: #000;
            border-radius: 8px;
        }

        textarea {
            width: 100%;
            min-height: 100px;
            font-size: 12px;
        }

        button {
            margin: 4px 0;
            padding: 6px 10px;
        }
    </style>
</head>

<body>
    <header>WebRTC минимал (сжатие быстрее на телефонах)</header>
    <main>
        <button id="btnStart">Камера+микрофон</button>
        <video id="local" autoplay playsinline muted></video>
        <video id="remote" autoplay playsinline></video>
        <div>
            <h3>Звонящий</h3>
            <button id="btnOffer">Создать Offer</button>
            <textarea id="offer" placeholder="Сжатый Offer"></textarea>
            <button id="btnSetAnswer">Вставить Answer → Set Remote</button>
            <textarea id="answerIn" placeholder="Сжатый Answer"></textarea>
        </div>
        <div>
            <h3>Отвечающий</h3>
            <button id="btnMakeAnswer">Вставить Offer → Answer</button>
            <textarea id="offerIn" placeholder="Сжатый Offer"></textarea>
            <textarea id="answerOut" placeholder="Сжатый Answer"></textarea>
        </div>
    </main>
    <script>
        const $ = id => document.getElementById(id);
        let pc, localStream;

        function createPeer() {
            if (pc) return pc;
            pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            pc.ontrack = e => { $("remote").srcObject = e.streams[0]; };
            return pc;
        }

        async function startLocal() {
            if (localStream) return;
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            $("local").srcObject = localStream;
            createPeer();
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        }

        function compress(obj) {
            const str = JSON.stringify(obj);
            const binStr = pako.deflate(str, { to: 'string' });
            return btoa(binStr);
        }
        function decompress(str) {
            const binStr = atob(str);
            const inflated = pako.inflate(binStr, { to: 'string' });
            return JSON.parse(inflated);
        }

        async function makeOffer() {
            await startLocal();
            createPeer();
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await new Promise(r => { if (pc.iceGatheringState === 'complete') return r(); pc.onicegatheringstatechange = () => { if (pc.iceGatheringState === 'complete') r(); }; });
            $("offer").value = compress(pc.localDescription);
        }

        async function acceptOfferAndMakeAnswer() {
            await startLocal();
            createPeer();
            const offer = decompress($("offerIn").value.trim());
            await pc.setRemoteDescription(offer);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            await new Promise(r => { if (pc.iceGatheringState === 'complete') return r(); pc.onicegatheringstatechange = () => { if (pc.iceGatheringState === 'complete') r(); }; });
            $("answerOut").value = compress(pc.localDescription);
        }

        async function setRemoteAnswer() {
            const answer = decompress($("answerIn").value.trim());
            await pc.setRemoteDescription(answer);
        }

        $("btnStart").onclick = startLocal;
        $("btnOffer").onclick = makeOffer;
        $("btnMakeAnswer").onclick = acceptOfferAndMakeAnswer;
        $("btnSetAnswer").onclick = setRemoteAnswer;
    </script>
</body>

</html>